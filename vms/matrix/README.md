# Plan: VM-Based Services with a Dedicated Traefik VM

This document outlines the plan to migrate internet-facing services into virtual machines (VMs), fronted by a dedicated Traefik reverse proxy VM. This makes the entire setup host-agnostic and portable.

## 1. Guiding Principle

All internet-facing services, including the reverse proxy, will run in their own dedicated VMs. The host machine's primary roles are to run the VMs and forward network traffic to the Traefik VM.

## 2. Project Structure

- **`vms/traefik/`**: This new directory will contain the configuration for the dedicated Traefik reverse proxy VM.
- **`vms/matrix/`**: This directory will house the Matrix service VM's configuration.
- **`modules/services/`**: Generic, reusable service modules (like Traefik, Matrix) will be moved here from `hosts/ivy/services/` to be used by any VM.

## 3. Networking Architecture

1.  **Virtual Bridge**: The host machine will be configured to create a virtual network bridge. This allows all VMs to communicate with each other over a private network.
2.  **Static IPs**: Each VM (Traefik, Matrix, etc.) will be assigned a static private IP address on the virtual bridge, ensuring stable internal communication.
3.  **Port Forwarding**: The host's firewall will be configured to forward all incoming public traffic on ports 80 and 443 to the Traefik VM's static private IP.

## 4. VM Configurations

### Traefik VM (`vms/traefik/`)

- **`default.nix`**: Defines the VM's resources and its connection to the virtual bridge.
- **`configuration.nix`**: Imports the generic Traefik service module. The Traefik configuration will use file-based discovery to dynamically route traffic to other service VMs based on configuration files generated during the NixOS build.

### Matrix VM (`vms/matrix/`)

- **`default.nix`**: Defines the VM's resources and connects it to the same virtual bridge.
- **`configuration.nix`**: Imports the generic Matrix service module. This VM will not have any public-facing ports; it will only be accessible via the Traefik VM.

## 5. Implementation Steps

1.  **Create `vms/traefik/` directory** and its `default.nix` and `configuration.nix` files.
2.  **Generalize Service Modules**: Move and refactor the configurations from `hosts/ivy/services/traefik.nix` and `hosts/ivy/services/matrix.nix` into reusable modules in `modules/services/`.
3.  **Update Host Configuration** (e.g., `hosts/ivy/configuration.nix`):
    - Add the virtual bridge configuration.
    - Set up port forwarding rules (80, 443) to the Traefik VM.
    - Remove the direct Traefik and Matrix service configurations.
    - Add the new VM definitions to be started by the host.
4.  **Implement Dynamic Routing**: Configure Traefik to read routing rules from a file that will be generated by Nix, containing the private IP addresses of the service VMs.

Please review this updated plan. Once you approve, I will proceed with the implementation.